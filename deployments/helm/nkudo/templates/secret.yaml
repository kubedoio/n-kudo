{{- if not .Values.security.externalSecrets.enabled }}
---
# Main security secret
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "nkudo.securitySecretName" . }}
  labels:
    {{- include "nkudo.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
data:
  admin-key: {{ include "nkudo.adminKey" . | b64enc | quote }}
  jwt-secret: {{ include "nkudo.jwtSecret" . | b64enc | quote }}

---
{{- if .Values.security.mtls.enabled }}
# CA certificates secret
{{- if not .Values.security.mtls.existingCASecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "nkudo.caSecretName" . }}
  labels:
    {{- include "nkudo.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: kubernetes.io/tls
data:
  {{- if and .Values.security.mtls.caCert .Values.security.mtls.caKey }}
  ca.crt: {{ .Values.security.mtls.caCert | quote }}
  ca.key: {{ .Values.security.mtls.caKey | quote }}
  {{- else }}
  {{- $ca := genCA "nkudo-ca" 3650 }}
  ca.crt: {{ $ca.Cert | b64enc | quote }}
  ca.key: {{ $ca.Key | b64enc | quote }}
  {{- end }}
{{- end }}
{{- end }}

---
{{- if .Values.backup.enabled }}
{{- if .Values.backup.s3.enabled }}
{{- if not .Values.backup.s3.existingSecret }}
# S3 backup credentials secret
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "nkudo.s3SecretName" . }}
  labels:
    {{- include "nkudo.labels" . | nindent 4 }}
type: Opaque
data:
  access-key: {{ .Values.backup.s3.accessKey | b64enc | quote }}
  secret-key: {{ .Values.backup.s3.secretKey | b64enc | quote }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}

---
# Database URL secret
{{- if .Values.postgresql.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "nkudo.fullname" . }}-db-url
  labels:
    {{- include "nkudo.labels" . | nindent 4 }}
type: Opaque
stringData:
  database-url: |
    postgresql://{{ .Values.postgresql.auth.username }}:{{ include "nkudo.postgresql.password" . }}@{{ include "nkudo.postgresql.fullname" . }}:5432/{{ .Values.postgresql.auth.database }}?sslmode=disable
{{- else }}
{{- if not .Values.database.external.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "nkudo.fullname" . }}-db-url
  labels:
    {{- include "nkudo.labels" . | nindent 4 }}
type: Opaque
stringData:
  database-url: |
    postgresql://{{ .Values.database.external.user }}:{{ .Values.database.external.password }}@{{ .Values.database.external.host }}:{{ .Values.database.external.port }}/{{ .Values.database.external.database }}?sslmode={{ .Values.database.external.sslMode }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "nkudo.fullname" . }}-db
  labels:
    {{- include "nkudo.labels" . | nindent 4 }}
type: Opaque
data:
  password: {{ .Values.database.external.password | b64enc | quote }}
{{- end }}
{{- end }}
