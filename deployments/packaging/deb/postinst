#!/bin/bash
set -e

# n-kudo edge agent post-installation script

USER="nkudo-edge"
GROUP="nkudo-edge"
DATA_DIR="/var/lib/nkudo-edge"
CONFIG_DIR="/etc/nkudo-edge"

# Create group if it doesn't exist
if ! getent group "$GROUP" > /dev/null 2>&1; then
    groupadd --system "$GROUP"
fi

# Create user if it doesn't exist
if ! id -u "$USER" > /dev/null 2>&1; then
    useradd --system --gid "$GROUP" --home-dir "$DATA_DIR" \
        --shell /usr/sbin/nologin --comment "n-kudo edge agent" "$USER"
fi

# Create directories
mkdir -p "$DATA_DIR"/{state,pki,vms}
mkdir -p "$CONFIG_DIR"

# Set permissions
chown -R root:root /usr/local/bin/nkudo-edge
chmod 755 /usr/local/bin/nkudo-edge

chown -R "$USER:$GROUP" "$DATA_DIR"
chmod 750 "$DATA_DIR"
chmod 750 "$DATA_DIR"/{state,pki,vms}

chown root:root "$CONFIG_DIR"
chmod 755 "$CONFIG_DIR"

# Set permissions for config file if it exists
if [ -f "$CONFIG_DIR/nkudo-edge.env" ]; then
    chown root:root "$CONFIG_DIR/nkudo-edge.env"
    chmod 640 "$CONFIG_DIR/nkudo-edge.env"
fi

# Reload systemd daemon
if systemctl daemon-reload 2>/dev/null; then
    # Enable the service
    systemctl enable nkudo-edge.service
    
    # Start the service if not running in chroot
    if ! ischroot 2>/dev/null; then
        systemctl start nkudo-edge.service || true
    fi
fi

#DEBHELPER#

exit 0
