name: Helm Charts

on:
  push:
    branches: [main, master]
    paths:
      - 'deployments/helm/**'
      - '.github/workflows/helm.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'deployments/helm/**'
      - '.github/workflows/helm.yml'
  release:
    types: [published]
  workflow_dispatch:

env:
  HELM_VERSION: '3.13.0'
  KIND_VERSION: '0.20.0'
  KUBECTL_VERSION: '1.28.0'

jobs:
  # ============================================================================
  # Lint Helm Charts
  # ============================================================================
  lint:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install Helm unittest plugin
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest.git || true

      - name: Lint Helm charts
        run: |
          for chart in deployments/helm/*/; do
            echo "Linting $chart..."
            helm lint "$chart"
          done

      - name: Run Helm template validation
        run: |
          for chart in deployments/helm/*/; do
            echo "Validating templates for $chart..."
            helm template test-release "$chart" --debug > /dev/null
          done

      - name: Check for Helm best practices
        run: |
          # Check if Chart.yaml has required fields
          for chart in deployments/helm/*/; do
            echo "Checking $chart Chart.yaml..."
            
            if [ ! -f "$chart/Chart.yaml" ]; then
              echo "ERROR: Chart.yaml not found in $chart"
              exit 1
            fi
            
            # Check for required fields
            for field in apiVersion name version; do
              if ! grep -q "^${field}:" "$chart/Chart.yaml"; then
                echo "ERROR: Required field '${field}' missing in $chart Chart.yaml"
                exit 1
              fi
            done
          done

  # ============================================================================
  # Test Helm Install on Kind
  # ============================================================================
  test-install:
    name: Test Helm Install
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s/release/v${{ env.KUBECTL_VERSION }}/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          version: v${{ env.KIND_VERSION }}
          cluster_name: nkudo-test
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
              - role: control-plane
                kubeadmConfigPatches:
                  - |
                    kind: InitConfiguration
                    nodeRegistration:
                      kubeletExtraArgs:
                        node-labels: "ingress-ready=true"

      - name: Test Helm install (dry-run)
        run: |
          for chart in deployments/helm/*/; do
            echo "Testing dry-run install for $chart..."
            helm install test-release "$chart" \
              --dry-run \
              --debug \
              --set postgresql.enabled=false \
              --set image.tag=latest
          done

      - name: Test Helm install
        run: |
          # Install PostgreSQL first (dependency)
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update
          
          # Install the chart
          helm install nkudo-test ./deployments/helm/nkudo \
            --wait \
            --timeout 5m \
            --set postgresql.auth.password=testpassword \
            --set postgresql.auth.postgresPassword=testpassword

      - name: Verify installation
        run: |
          kubectl get pods
          kubectl get services
          
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=nkudo --timeout=120s || true

      - name: Test Helm upgrade
        run: |
          helm upgrade nkudo-test ./deployments/helm/nkudo \
            --wait \
            --timeout 5m \
            --set postgresql.auth.password=testpassword \
            --set replicaCount=2

      - name: Test Helm rollback
        run: |
          helm rollback nkudo-test 0
          helm status nkudo-test

      - name: Cleanup
        if: always()
        run: |
          helm uninstall nkudo-test || true
          kubectl delete pvc --all || true

  # ============================================================================
  # Release Helm Chart
  # ============================================================================
  release:
    name: Release Helm Chart
    runs-on: ubuntu-latest
    needs: [lint, test-install]
    if: github.event_name == 'release' && github.event.action == 'published'
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Get release version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update chart version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          sed -i "s/version: .*/version: ${VERSION}/" deployments/helm/nkudo/Chart.yaml
          sed -i "s/appVersion: .*/appVersion: \"${VERSION}\"/" deployments/helm/nkudo/Chart.yaml

      - name: Update dependencies
        run: |
          helm dependency update deployments/helm/nkudo

      - name: Package Helm chart
        run: |
          mkdir -p .cr-release-packages
          helm package deployments/helm/nkudo -d .cr-release-packages/

      - name: Upload chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-release
          path: .cr-release-packages/*.tgz

      - name: Publish to GitHub Container Registry
        run: |
          # Login to GHCR
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Package and push
          VERSION=${{ steps.version.outputs.version }}
          helm package deployments/helm/nkudo
          helm push nkudo-${VERSION}.tgz oci://ghcr.io/${{ github.repository_owner }}/helm-charts

      - name: Update Helm repository index
        if: github.ref == 'refs/tags/v0.0.0'  # Enable when gh-pages is set up
        run: |
          # This would update the index.yaml on gh-pages branch
          echo "Updating Helm repository index..."
          # helm repo index .cr-release-packages --url https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}

  # ============================================================================
  # Helm Chart Security Scan
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Run Helm template and scan with Trivy
        run: |
          for chart in deployments/helm/*/; do
            echo "Scanning $chart..."
            helm dependency update "$chart" 2>/dev/null || true
            helm template test "$chart" > rendered.yaml || true
            
            if [ -f rendered.yaml ]; then
              # Trivy scan would go here
              echo "Rendered manifest created for scanning"
              rm rendered.yaml
            fi
          done

      - name: Check for sensitive data in Helm templates
        run: |
          # Check for hardcoded passwords or secrets
          if grep -r "password:" deployments/helm/*/templates/ 2>/dev/null | grep -v "{{"; then
            echo "WARNING: Potential hardcoded password found"
            exit 1
          fi
          
          if grep -r "secret:" deployments/helm/*/templates/ 2>/dev/null | grep -v "{{" | grep -v "secretName"; then
            echo "WARNING: Potential hardcoded secret found"
            exit 1
          fi
          
          echo "No hardcoded secrets found in templates"

  # ============================================================================
  # Helm Summary
  # ============================================================================
  helm-summary:
    name: Helm Summary
    runs-on: ubuntu-latest
    needs: [lint, test-install, security-scan]
    if: always()
    steps:
      - name: Summarize Helm results
        run: |
          echo "## Helm Chart Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Install | ${{ needs.test-install.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
